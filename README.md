# TSAR — AI/ML система детекции газов (THz): от ТЗ к верифицированному решению

Публичный демонстрационный репозиторий, показывающий, как из формального технического задания (ТЗ) была построена и проверена AI/ML-система: **генерация данных → вероятностная модель → правило детекции → перенос на реальные измерения**.

Цель репозитория — не “выложить весь исследовательский код”, а **показать продуктовый контур работ**:
- как требования превращаются в технические подходы;
- как выявляются ключевые риски (ложные тревоги);
- как подтверждается работоспособность на синтетике и на реальных спектрах;
- почему подход переносим на другие установки (при наличии калибровочных профилей).

---

## Поставленная задача

- **ТЗ:** построить основу интеллектуального THz-газоанализа опасных примесей: данные + модель + валидация в реалистичных условиях.
- **Сделано:** генератор реалистичных спектров (смеси/влажность/артефакты прибора) + модель TSAR (μ/σ) + детектор `Tμ/Tσ`.
- **Ключевая проблема:** ложные срабатывания в зоне около/ниже порога детекции.
- **Решение:** использовать предсказанную неопределённость `σ` как меру доверия и подобрать пороги `Tσ` на большой синтетической тестовой выборке для подавления ложных срабатываний, затем перенести на реальные измерения.
- **Результат:** подход подтверждён на независимой тестовой синтетике и на реальных экспериментах (включая режимы высокой влажности).

---

## Скриншоты

**GUI генератора спектров (диапазон, профили шума/базовой линии/отсечки, пакетная генерация):**  
![Интерфейс генератора](assets/ui.png)

**Демонстрация аугментаций (приближение синтетики к реальному прибору):**  
Красная линия — модельный спектр NH₃ (HITRAN/модель, фиксированная влажность). Чёрный пунктир — тот же спектр после наложения реалистичных эффектов измерения.
- частотно-зависимый шум по профилю из калибровочных экспериментов;
- дрейф базовой линии (включая PCA-компоненты) и случайный offset;
- динамическая отсечка и эффекты насыщения детектора.  
Идея: генератор позволяет масштабно получать данные для обучения — **смеси и одиночные газы** в широком диапазоне log10-концентраций и при разных фоновых условиях (включая влажность), сохраняя параметры аугментаций для воспроизводимости.  
![Аугментации](assets/augmentations.jpg)

**Детекция на реальном эксперименте (серия NH₃, вероятностный выход μ/σ):**  
Показаны предсказания `log10(c)` и доверительные интервалы, построенные по `(μ, σ)`.
- целевой газ (NH₃) уверенно выделяется: выше порога по концентрации и с минимальной неопределённостью (узкий интервал);
- нецелевые газы остаются ниже порога и/или имеют повышенную σ (модель не “притворяется уверенной” около LOD);
- финальное решение принимает двухфакторный детектор по порогам `Tμ` и `Tσ`, где `Tσ` подбирается на большой синтетической тестовой выборке для подавления ложных срабатываний и затем переносится на реальные измерения.  
![Реальные данные: NH3](assets/real_nh3_detection.jpg)

---

## Что было в ТЗ и что сделано 

### ТЗ (суть в прикладных терминах)
- обеспечить возможность построения интеллектуального газоанализа по THz-спектрам;
- учесть реалистичные условия измерений (смеси, влажность, нестабильности прибора);
- обеспечить переносимость подхода на реальные данные и работоспособность в эксперименте.

### Что получено
1) **Генератор данных** для обучения и тестирования: модельные спектры + реалистичные аугментации (профили шума/базовой линии/отсечки, насыщение).  
2) **Вероятностная модель TSAR**: выдаёт `(концентрацию, неопределенность)` в `log10(c)` для каждого газа.  
3) **Правило детекции** (`Tμ/Tσ`), ориентированное на снижение ложных тревог.  
4) **Валидация**: независимая синтетическая тестовая выборка + серии реальных экспериментов.

---

## Ключевая проблема: ложные тревоги в зоне LOD — и как она решена

Вблизи предела обнаружения (LOD) модель может выдавать значения чуть ниже/чуть выше порога. Для продукта это риск: ложные тревоги и “шумные” детекции.

Принята стратегия:
- концентрационный порог `Tμ` задаётся относительно LOD;
- неопределённость `σ` используется как индикатор доверия: высокая `σ` → предсказание “пограничное”;
- пороги `Tσ` подбираются на большой тестовой синтетике с приоритетом **минимизации ложных срабатываний**;
- затем эти пороги фиксируются и переносятся на реальные измерения.

---

## Переносимость на другие установки

Подход переносим, потому что:
- входные спектры приводятся к общему виду только интерполяцией на фиксированную сетку (без ручной предобработки типа baseline correction / peak picking);
- различия установок “вшиваются” через калибровочные профили (шум, базовая линия/дрейф, отсечка, насыщение) и через правила детекции по `(μ, σ)`.

---

## Что опубликовано в репозитории

Это “витринная” версия подхода:
- `src/generator_excerpt.py` — концептуальная выжимка генерации и аугментаций
- `src/model_hybrid_excerpt.py` — архитектура TSAR (EfficientNet-B5 + Transformer, выход μ/σ)
- `src/thresholds_real_validation_excerpt.py` — логика порогов `Tμ/Tσ` и перенос на реальные спектры
- `assets/` — иллюстрации для README

---
## Контакты
- ФИО: Кожевников Филипп Алексеевич
- Профиль достижений: istina.msu.ru/workers/635846702/
